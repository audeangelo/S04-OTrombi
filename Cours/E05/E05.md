# Session & cookie

## Planning Journée
```
- Correction 2h30
- Injection SQL 30mn

### Après midi

- COOKIE
- SESSION
```

## SQL

```sql
-- nombre d'enregistrement / ligne dans la table promo
-- renvoie le nombre de promotion dans la table promo
select count(*) AS number_promo from promo;
```

```sql
-- nombre d'étudiants de chaque promo (prom_id) à partir de la table student
SELECT "promo_id", count(*) FROM "student" GROUP BY "promo_id";
-- te donne le nombre d'étudiant sur une promo
SELECT count(*) FROM "student" WHERE "promo_id"=694;
```


## Injection SQL

**probleme**: n'importe quel petit malin avec un poil de connaissance en conception de BDD peut injecter du SQL dans notre code

Si on ajoute un étudiant qui a le prénom : `','','',1); DELETE FROM student; --`

Cela revient à éxécuter cette commande SQL: 
```sql
INSERT INTO student ("first_name", "last_name", "github_username", "promo_id") 
    VALUES ('','','',1); DELETE FROM student; --','Nom', 'PrenomNom', '1')
```

**requete préparé**

exemple du résultat avec une requete préparé
```sql
INSERT INTO student ("first_name", "last_name", "github_username", "promo_id") 
    VALUES (('','','',1); DELETE FROM student; ','Nom', 'PrenomNom', '1'), "", "", 1),
```

Pour faire une requete préparé 2 méthodes

```js
// on remplace les variables par des jetons (ou tokens) 
// ils ont tous le même format : $X, et X commence à 1 (pas à 0, attention !)
const sql = `INSERT INTO student (first_name, last_name, github_username, promo_id) VALUES ($1,$2,$3,$4)`;
// puis on construit un tableau avec les variables à injecter, dans le bon ordre !
const values = [first_name,last_name,github_username,promo];
// et on donne le tout à pg directement !
client.query(sql, values );
```
OU
```js
const sql = {
    text: `INSERT INTO student (first_name, last_name, github_username, promo_id) VALUES ($1,$2,$3,$4)`,
    values: [first_name,last_name,github_username,promo]
}
client.query(sql)
```

**on utilisera toujours cette méthodes pour ajouter des variables dans le sql**

## Cookies et Session

**probleme**: tout le monde peut ajouter un étudiant dans notre projet trombi

**Objectif du cookie + de la session**
Une seule personne puisse ajouter un étudiant dans une promo. on ne veut pas que cette fonctionnalité soit ouverte à tous
Si notre stagiaire ferme l'onglet de son navigateur et bien qu'il ne soit pas obligé de se reconnecter à chaque fois

### Les cookies

Les cookies nous permet de laisser le navigateur se rappeler de toutes les informations "temporaires". Si je ferme un onglet du navigateur et que je reviens dessus, il va se souvenir de mon cookie

un cookie est:
- prore à un nom de domaine / quelque soit la route du domaine, je vais u avoir acces
- contient des infos propres à un client / navigateur. Inverse d'une BDD qui elle, sont des infos communes distribué grace au serveur

exemple : un login, panier d'article, favoris

**fiable MAIS QUI N'EST PAS SECURISE**

## Session

De mettre les "infos sensibles", dans un fichier. Il faut s'assurer que Jean n'accède à la page ajout étudiant, que seul Michel y est accès

### express-session pour gérer une session (des données persos du navigateur = cookie) et générer un token (un jeton)

npm express session nous permet de créer un **jeton** pour stocker les données d'un utilisateur de manière sécurisé coté serveur (mémoire vive du serveur). Ils disparaissent dés lors que je relance le serveur.

https://github.com/expressjs/session

Ce middlware envoie au navigateur un cookie avec un jeton crypté

dans le fichier index.js
```js
const session = require('express-session');

app.use(session({
  secret: 'keyboard cat', // le "secret" qui sert à générer les tokens. ELLE DOIT ETRE MISE DANS LE .ENV
  resave: true, // sauvegarde automatique de la session à la fin de la requête ? 
  saveUninitialized: true, // sauvegarde de la session même si elle est vide ?
  cookie: {
    // des options pour le cookie qui contient le token. cf npmjs.com/package/express-session
  }
}));
```

Pour stocker une donnée dans la session on fait : `request.session.login = req.body.login;`

et pour la lire, on fait `request.session`

## Récapitulatif

Un cookie c'est :
- stocké coté navigateur
- un bout de texte format cle=valeur
- fiable: envoyé au serveur à chaque requete
- non sécurisé: lisible et totalment modifiable par l'utilisateur

Une session c'est :

- stocké sur le serveur
- identifié par un token unique confié au client **dans le cookie**
- sécurisé: inaccessible aux utilisateurs (coté navigateur)
- fiable: puisque repose sur le principe des cookies

**top si je veux que le navigateur se souvienne de mon authentification ou d'un panier d'achat**

