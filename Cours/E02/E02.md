# Organiser sa BDD

- [Organiser sa BDD](#organiser-sa-bdd)
  - [Planning Journ√©e](#planning-journ√©e)
  - [Base de donn√©es - Constat](#base-de-donn√©es---constat)
  - [PostgreSQL](#postgresql)
  - [Mod√©lisation](#mod√©lisation)
  - [M√©thodologie classique en mod√©lisation de donn√©es : MERISE](#m√©thodologie-classique-en-mod√©lisation-de-donn√©es--merise)
  - [MCD - Mod√®le Conceptuel de Donn√©es](#mcd---mod√®le-conceptuel-de-donn√©es)
    - [Sch√©matisation du MCD](#sch√©matisation-du-mcd)
  - [MLD - Mod√®le Logique de Donn√©es](#mld---mod√®le-logique-de-donn√©es)
    - [R√®gle de traduction de l'association](#r√®gle-de-traduction-de-lassociation)
  - [Se connecter √† un serveur Postgres sur les serveur (distant) de Oclock !](#se-connecter-√†-un-serveur-postgres-sur-les-serveur-distant-de-oclock-)
  - [SQL - Structured Query Langage](#sql---structured-query-langage)
  - [Connexion √† Postgres depuis Node.js](#connexion-√†-postgres-depuis-nodejs)
    - [Sch√©ma classique pour les addresse de BDD :](#sch√©ma-classique-pour-les-addresse-de-bdd-)
    - [avec un objet:](#avec-un-objet)
    - [callback vs promesse](#callback-vs-promesse)
    - [Notes](#notes)

## Planning Journ√©e

```
- Correction 1h:
    - route `/promo/:id/students`
    - route `/student/:id`
    - dossier public
    - librairie CSS
- Mod√©lisation BDD 1h30: EN MD + SCHEMA
    - MCD
    - MLD

### Apr√®s midi

- SQL 1h: on utilise une BDD partag√© (pas modifiable): SUR LE TERMINAL
    - Intro_sql
    - Vocabulaire
    - Serveur `Postgres`
    - Client terminal `psql`
    - Requ√™tes `SQL`
- SQL et JS 1h (atelier): DANS LE PROJET test_sql.js
    - Client Node `pg`
```

## Base de donn√©es - Constat

- `JSON` :

  - c'est bien, mais s'il faut le renvoyer et le remplacer √† chaque fois, c'est p√©nible
  - s'il faut le modifier programmatiquement, c'est p√©nible.

C'est normal c'est pas pr√©vu pour ! Le JSON c'est pr√©vu pour transf√©rer des donn√©es, pas vraiment pour les stocker

On a besoin d'un syst√®me dont la vocation est de STOCKER, STRUCTURER, FOURNIR de la donn√©es.
  - **Syst√®me de Gestion de Bases de Donn√©es**

## PostgreSQL

d√©ja install√© sur la VM sinon, il faut l'installer sur son ordi (comme node)

- `SGBD` (üá¨üáß DBMS) =

  - Syst√®me de Gestion de Bases de Donn√©es (Database Management Syst√®me)
  - **Serveur** (camion qui roule en permanence et dans lequel on trouve des colis)
  - c'est postgreSQL

- `BDD` (üá¨üáß DB) =

  - Base de donn√©es (Database)
  - Une sorte de "colis", structur√©

- `Tables`

  - Une BDD est compos√©es de plusieurs "tables" qui structure nos donn√©es
  - ex : `student` // `promo`

- `Champs`
  - Les propri√©t√©s d'une table
    - ex : pour la table `student` : un pr√©nom, un nom, un photo_url, etc...

R√©pond √† la question : **Comment stocker la donn√©es ??**

SGBDR vs NoSQL : plus facile de voir celui l√† avant, pour passer sur du nosql plus tard que inversement 

## Mod√©lisation

R√©pond √† la question : **Quelles donn√©es stock√©es ??**

## M√©thodologie classique en mod√©lisation de donn√©es : MERISE

- üá´üá∑ franco-fran√ßaise, mais une des m√©thodes les plus utilis√©s pour mod√©liser.
- normalis√© : r√®gles √† respecter pour bien le faire.

`MERISE` = faire :

- un `MCD` : Mod√®le Conceptuel de Donn√©es
- un `MLD` : Mod√®le Logique de Donn√©es

si la BDD est bien faite, √ßa va √™tre plaisant et facile √† manipuler
si la BDD est mal pens√©e, chaque route va devenir une horreur √† impl√©menter

## MCD - Mod√®le Conceptuel de Donn√©es

https://kourou.oclock.io/ressources/fiche-recap/mcd-modele-conceptuel-de-donnees/

Le MCD est un exercice tr√®s acad√©mique, tr√®s normalis√©, dont l'expression se fait g√©n√©ralement sous la forme d'un SCHEMA (sch√©ma `Entit√©-Relation` ou sch√©ma `Entit√©-Association`)

Objectif : identifier les diff√©rentes entit√©s et leurs associations.

Ce n'est pas un document TECHNIQUE :

- on parle pas d'`ID`
- on parle pas de `table`/`champs`/`enregistrement`
- on parle pas de cl√© primaire/cl√© √©trang√®re

Brouillon de nos donn√©es :

- lister les **entit√©s** de notre probl√®me: 
  - ***quelles sont les donn√©es dont nous avons besoin ?***
- lister les **discriminants** (**identifiant**) de nos entit√©s : un attribut qui caract√©rise de mani√®re unique une entit√©
  - ***qu'est ce qui caract√©rise de mani√®re unique une entit√©' ?***
- lister les **attributs** de nos entit√©s: qu'est ce qui caract√©rise notre donn√©e ?
  - ***qu'est ce qui caract√©rise notre donn√©e ?***
- lister les **associations** entre nos entit√©s :
  - ***quelle verbe lie nos 2 entit√©es ?***

```
Etudiant : code etudiant, pseudo github, pr√©nom, nom, URL de photo

Promotion : code promotion, nom, URL Github

un √©tudiant APPARTIENT √† une et une seule Promotion
```

On passe au dessin :

- carr√© pour les entit√©s et leurs attributs
- souligner le discriminent
- rond pour le nom de l'association (+ trait entre les deux)
- de part et d'autre de l'association, on pr√©cise les **cardinalit√©s** de cette association.

### Sch√©matisation du MCD

Quel outil :

- papier/crayon
- drawio (Google)
- tldraw
- excalidraw
- MoCoDo (sous forme de code)

Conseil :

- installer l'extension VSCode `Draw.io Integration`
- cr√©er un fichier avec l'extension `.drawio`

![Alt text](ressources/mcd.png)

**Les cardinalit√©s** sont :

- Les quantit√©s minimum et maximum qui peuvent exister entre deux entit√©s A et B,
- de A vers B et de B vers A,
  cela implique donc 4 cardinalit√©s par relation, pour les trouver posons-nous ces questions :

Type de formulation
- A combien de promotion, un √©tudiant peut appartenir au minimum ? => 1
***ou*** Un etudiant appartient au minimum √† combien de promotion ? => 1
- A combien de promotion, un √©tudiant peut appartenir au maximum ? => 1
***ou*** Un etudiant appartient au maximum √† combien de promotion ? => 1
- Combien d'√©tudiants peuvent √™tre dans une promotion, au minimum ? => 0
***ou*** Une promotion a combien d'√©tudiants au minimum ? => 0
- Combien d'√©tudiants peuvent √™tre dans une promotion, au maximum ? => N
***ou*** Une promotion a combien d'√©tudiants au maximum ? => N

Partant de l√†, les valeurs possibles pour les cardinalit√©s sont : (0,1) (1,1) (0,n) (1,n).


## MLD - Mod√®le Logique de Donn√©es

https://kourou.oclock.io/ressources/fiche-recap/mld/

Objectif : traduire le MCD en vu d'√™tre impl√©menter dans un vrai syst√®me de gestion de base de donn√©es.

- Chaque `entit√©s` devient une `table`
- Chaque `attributs` devient un `champs`
- pr√©ciser les **types** de donn√©es qu'on stocke (ex: chaine de caract√®re, nombre...)
- traduire les `associations`, plusieurs :
  - cl√©s primaire/√©trang√®res (on va aller vite, on le reverra E04 !)
  - tables de liaisons (fin de saison)

**Conventions de nommage** :

- `snake_case`, sans majuscule
- nom de tables au `singulier`, en minuscule

Moins normaliser, possiblit√© de le faire en texte ou en sch√©ma

**[Version Texte]** :

```
student (
  id                      (nombre)
  first_name              (chaine de caract√®re)
  last_name               (chaine de caract√®re)
  profile_picture_url     (chaine de caract√®re - URL)
  github_username         (chaine de caract√®re)
  promo_id                (#FK->promo.id)
)

promo (
  id,                     (nombre)
  name,                   (chaine de caract√®re - 200 caract√®res max)
  github_organization     (chaine de caract√®re - URL)
)
```

### R√®gle de traduction de l'association

Regarder les cardinalit√©s

```
ETUDIANT <---- 1,1 ----> APPARTIENT <---- 0,N ----> PROMOTION
               ^                           ^
              max(1,1) = 1                max(0,N) = N

==> Ici, un √©tudiant appartient √† au moins et au max une seul promotion
==> Une promotion a mini 0 √©tudiant jusqu'√† X √©tudiants (N)
```

**D'o√π vient ce promo_id dans la table student ? Associations** :
On verra les 3 types d'associations en E07, pour l'instant `One-to-Many`
  - on rajoute un ID sur une table qui pointe vers l'autre,
  - cet id se nomme une "cl√© √©trang√®re" ou "foreign key"
  - On la met sur la table qui √† la cardinalit√© 1


**[Version Schematique]** :

![Alt text](ressources/mld.png)

## Se connecter √† un serveur Postgres sur les serveur (distant) de Oclock !

On a dessin√© une base de donn√©es! Pour aujourd'hui, on zappe la partie cr√©ation, c'est pour E03.

![](ressources/postgres.png)

On a besoin du VPN -> le t√©l√©porteur lanc√©.

`psql --version`, pour v√©rifier que psql est bien install√© et connaitre sa version

- Ouvrir un terminal dans la VM T√©l√©porteur
- `psql -h pg.oclock.lan -U etudiant -d trombi`

  - mdp : `js4life`

-h => host
-U => username
-d => nom de la bdd

- On r√©cup√®re **un prompt psql : `trombi =>`**
- 
## SQL - Structured Query Langage

C'est un langage (universel dans le sens o√π il est utilis√© par plusieurs SGBD dif√©rent) pour requeter des donn√©es dans une BDD !

Si on cherche une commande particuli√®re, [la documentation est votre amie](https://sql.sh/) !

[Fiche recap kourou SQL](https://kourou.oclock.io/ressources/fiche-recap/le-langage-sql/)

Notre premi√®re requ√™te SQL :

`\dt`: Listes des tables
`\d + nom`: D√©crire une table

`\q` ou `exit`: Pour sortir

[Nos 1eres lignes sql](intro_sql.sql)


**Attention** :

- **NE PAS OUBLIER LE `;`**
- pour les noms de table, ajouter des guillemets double `"`
- pour les noms de champs, ajouter des guillemets double `"`
- pour les valeurs string, ajouter des giullemets simple `'`
- sensible √† la case (`F ‚â† f`)

## Connexion √† Postgres depuis Node.js

[Fiche recap Kourou](https://kourou.oclock.io/ressources/fiche-recap/se-connecter-a-une-bdd-postgresql-depuis-node-module-pg/)

Nous avons besoin d'un "client" / "driver" pour se faire !

Il s'appelle : `pg`. C'est un module `npm` !

https://www.npmjs.com/package/pg

### Sch√©ma classique pour les addresse de BDD : 

format: **protocol://user:password@host:port/database_name**

```js
const client = new Client(`postgres://etudiant:js4life@pg.oclock.lan:5432/trombi`);
```

### avec un objet:

```js
const client = new Client({
  host: 'pg.oclock.lan',
  port: 5432,
  database: 'trombi',
  user: 'etudiant',
  password: 'js4life',
})
```

### callback vs promesse

```js
client.query(query)
// renvoie une promesse en statut "pending", on peut alors utiliser le systeme de promesse pour r√©cup√©rer les donn√©es
```

[Doc promesse](https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Promise)

### Notes

- Dans Node.js `pg`, un `db.query` renverra TOUJOURS un ARRAY pour `result.rows`.

  - cet array peut contenir 0 √©l√©ment, ou 1 √©l√©ments, ou X √©l√©ments, selon la query et l'√©tat de la BDD.
  - le mieux, c'est de faire un console syst√©matiquement !
  - et penser aux cas d'erreurs !!!

- On peut ajouter plusieurs terminaux dans VSCode via le petit bouton `+` en haut des terminaux

- Raccourci : `CMD + K` / `CTRL + L` dans le terminal efface l'historique visible !

